<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Memory Game - {{ nivel|title }}</title>
    {% load static %}
    <link rel="icon" type="image/x-icon" href="{% static 'memory_game/icono.ico' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-container {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        .memory-card {
            width: 100px;
            height: 100px;
            background-color: #0d6efd;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .flipped {
            background-color: #ffc107;
            color: black;
        }

        .matched {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>

<body class="bg-dark text-light text-center">
    <div class="container py-4">
        <h2>üéØ Nivel: {{ nivel|title }}</h2>
        <h5>Intentos restantes: <span id="intentos">{{ intentos }}</span></h5>
        <h5>‚è∞ Tiempo restante: <span id="tiempo">{{ tiempo }}</span> s</h5>

        <div class="card-container" id="tablero"></div>

        <div class="mt-4">
            <a href="{% url 'seleccion_nivel' %}" class="btn btn-secondary">Cambiar Nivel</a>
            <a href="{% url 'index' %}" class="btn btn-primary">Volver al Inicio</a>
        </div>
        <audio id="sonidoGanar" src="{% static 'memory_game/audio/ganar.mp3' %}"></audio>
        <audio id="sonidoPerder" src="{% static 'memory_game/audio/perder.mp3' %}"></audio>

    </div>



    <!-- üéµ Audios -->
    <audio id="audioMatch" src="{% static 'memory_game/audio/match.mp3' %}" preload="auto"></audio>

    <audio id="audioMain" src="{% static 'memory_game/audio/main.mp3' %}" preload="auto" loop></audio>
    <audio id="audioWin" src="{% static 'memory_game/audio/win.mp3' %}" preload="auto"></audio>
    <audio id="audioLose" src="{% static 'memory_game/audio/lose.mp3' %}" preload="auto"></audio>

    <!-- üèÜ Modal de victoria -->
    <div class="modal fade" id="modalWin" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-success text-light text-center p-4">
                <h3>üéâ ¬°Felicidades!</h3>
                <p>Completaste el juego correctamente.</p>
                <button class="btn btn-light mt-3" onclick="location.reload()">Volver a jugar</button>
            </div>
        </div>
    </div>

    <!-- üíÄ Modal de derrota -->
    <div class="modal fade" id="modalLose" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-danger text-light text-center p-4">
                <h3>üò¢ Has perdido</h3>
                <p>Se acabaron los intentos o el tiempo.</p>
                <button class="btn btn-light mt-3" onclick="location.reload()">Intentar de nuevo</button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (para los modales) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        const tablero = document.getElementById('tablero');
        const intentosSpan = document.getElementById('intentos');
        const tiempoSpan = document.getElementById('tiempo');
        // Elementos de audio y modales
        const audioMain = document.getElementById('audioMain');
        const audioWin = document.getElementById('audioWin');
        const audioLose = document.getElementById('audioLose');
        const modalWin = new bootstrap.Modal(document.getElementById('modalWin'));
        const modalLose = new bootstrap.Modal(document.getElementById('modalLose'));
        const audioMatch = document.getElementById('audioMatch');

        audioMatch.volume = 0.6;
        audioMain.volume = 0.4;
        audioWin.volume = 0.7;
        audioLose.volume = 0.7;

        // Reproducir m√∫sica de fondo al iniciar el juego
        window.addEventListener('click', () => {
            // Esto se usa para evitar bloqueos de autoplay en navegadores
            if (audioMain.paused) {
                audioMain.play();
            }
        }, { once: true });


        let intentos = parseInt(intentosSpan.textContent);
        let tiempo = parseInt(tiempoSpan.textContent);
        let cartasVolteadas = [];
        let bloqueado = false;

        // Crear pares de cartas (8 pares = 16 cartas)
        const simbolos = ['üçé', 'üçå', 'üçá', 'üçí', 'üçâ', 'üçã', 'üçì', 'üçç'];
        let cartas = [...simbolos, ...simbolos];

        // Mezclar las cartas
        cartas.sort(() => Math.random() - 0.5);

        // Crear el tablero
        cartas.forEach((simbolo, index) => {
            const div = document.createElement('div');
            div.classList.add('memory-card');
            div.dataset.simbolo = simbolo;
            div.textContent = '?';
            div.addEventListener('click', () => voltearCarta(div));

            tablero.appendChild(div);
        });

        function voltearCarta(carta) {
            if (bloqueado || carta.classList.contains('matched') || cartasVolteadas.includes(carta)) return;

            carta.textContent = carta.dataset.simbolo;
            carta.classList.add('flipped');
            cartasVolteadas.push(carta);

            if (cartasVolteadas.length === 2) {
                bloqueado = true;
                setTimeout(() => {
                    verificarPareja();
                    bloqueado = false;
                }, 800);
            }
        }

        function verificarPareja() {
            const [c1, c2] = cartasVolteadas;
            if (c1.dataset.simbolo === c2.dataset.simbolo) {
                c1.classList.add('matched');
                c2.classList.add('matched');
                audioMatch.currentTime = 0; // Reinicia el sonido si se emparejan r√°pido
                audioMatch.play();
            } else {
                c1.textContent = '?';
                c2.textContent = '?';
                c1.classList.remove('flipped');
                c2.classList.remove('flipped');
                intentos--;
                intentosSpan.textContent = intentos;
                if (intentos <= 0) {
                    sonidoPerder.play();

                    function registrarResultado(resultado, tiempoRestante) {
                        fetch("/registrar-partida/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}",
                            },
                            body: JSON.stringify({
                                nivel: "{{ nivel }}",
                                resultado: resultado,
                                tiempo_restante: tiempoRestante,
                            }),
                        });
                    }
                    audioMain.pause();
                    audioMain.currentTime = 0;
                    registrarResultado("derrota", tiempo);
                    audioLose.play();
                    modalLose.show();
                }
            }

            cartasVolteadas = [];

            // Verificar victoria
            const todas = document.querySelectorAll('.memory-card');
            const ganadas = document.querySelectorAll('.matched');
            if (ganadas.length === todas.length) {

                function registrarResultado(resultado, tiempoRestante) {
                    fetch("/registrar-partida/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                        body: JSON.stringify({
                            nivel: "{{ nivel }}",
                            resultado: resultado,
                            tiempo_restante: tiempoRestante,
                        }),
                    });
                }
                audioMain.pause();
                audioMain.currentTime = 0;
                registrarResultado("victoria", tiempo);
                audioWin.play();
                modalWin.show();
            }
        }

        // Temporizador
        const cuentaRegresiva = setInterval(() => {
            tiempo--;
            tiempoSpan.textContent = tiempo;
            if (tiempo <= 0) {
                clearInterval(cuentaRegresiva);
                audioMain.pause();
                audioMain.currentTime = 0;
                registrarResultado("derrota", 0);
                audioLose.play();
                modalLose.show();
            }
        }, 1000);
    </script>
</body>

</html>